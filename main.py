import os
from fastapi import FastAPI
from contextlib import asynccontextmanager


# --- 1. –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –Ω–∞—à–∏ –º–æ–¥—É–ª–∏ ---
# –í–ê–ñ–ù–û: config –¥–æ–ª–∂–µ–Ω –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å—Å—è –¥–æ –º–æ–¥—É–ª–µ–π, –∫–æ—Ç–æ—Ä—ã–µ –µ–≥–æ –∏—Å–ø–æ–ª—å–∑—É—é—Ç.
# –û–Ω —Å–∞–º –∑–∞–≥—Ä—É–∑–∏—Ç –Ω—É–∂–Ω—ã–π .env –∏–ª–∏ .env.test —Ñ–∞–π–ª.
import config
# –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∂–∏–∑–Ω–µ–Ω–Ω—ã–º —Ü–∏–∫–ª–æ–º –ë–î
from database import connect_to_db, close_db_connection
# –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –≥–æ—Ç–æ–≤—ã–µ "—É–¥–ª–∏–Ω–∏—Ç–µ–ª–∏" (—Ä–æ—É—Ç–µ—Ä—ã) –∏–∑ –∫–∞–∂–¥–æ–≥–æ –º–æ–¥—É–ª—è
from auth import router as auth_router
# –î–æ–±–∞–≤–ª—è–µ–º –∏–º–ø–æ—Ä—Ç –¥–ª—è —Ä–æ—É—Ç–µ—Ä–∞ –ø—Ä–æ–¥—É–∫—Ç–æ–≤
from routers.products import router as products_router


# --- 2. –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∂–∏–∑–Ω–µ–Ω–Ω—ã–º —Ü–∏–∫–ª–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è ---

# –≠—Ç–æ –∫–∞–∫ "–≤—ã–∫–ª—é—á–∞—Ç–µ–ª—å" –¥–ª—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è, –Ω—É–∂–µ–Ω –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –≤–∫–ª—é—á–µ–Ω–∏—è –∏ –≤—ã–∫–ª—é—á–µ–Ω–∏—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ë–î
# # –ò–°–ü–†–ê–í–õ–ï–ù–û: –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–æ–≤—ã–π, —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π —Å–ø–æ—Å–æ–± —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∂–∏–∑–Ω–µ–Ω–Ω—ã–º —Ü–∏–∫–ª–æ–º - lifespan.
@asynccontextmanager
async def lifespan(app: FastAPI):
    """
    –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–æ–±—ã—Ç–∏—è–º–∏ "startup" –∏ "shutdown".
    –≠—Ç–æ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π –∏ –Ω–∞–¥–µ–∂–Ω—ã–π —Å–ø–æ—Å–æ–± —É–ø—Ä–∞–≤–ª—è—Ç—å —Ä–µ—Å—É—Ä—Å–∞–º–∏, —Ç–∞–∫–∏–º–∏ –∫–∞–∫ –ø—É–ª —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π —Å –ë–î.
    """
    print("Lifespan starting")
    
    # # --- –ù–∞—á–∞–ª–æ: –ö–æ–¥ –¥–æ yield ---
    # # –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –û–î–ò–ù –†–ê–ó –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ —Å–µ—Ä–≤–µ—Ä–∞
    app.state.pool = None
    # –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è, –µ—Å–ª–∏ TESTING –Ω–µ —Ä–∞–≤–µ–Ω 'True'
    if os.getenv("TESTING") != "True":
        print("Connecting to database...")
        await connect_to_db(app)

        print("\n" + "="*50)
        print("üöÄ  SERVER IS READY!")
        print("üëâ  Open Swagger UI: http://localhost:8001/docs")
        print("="*50 + "\n")
    else:
        print("TESTING mode: skipping DB connect")

    # --- –û—Å–Ω–æ–≤–Ω–∞—è —Ä–∞–±–æ—Ç–∞ ---
    yield # –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ "–∂–∏–≤–µ—Ç" –∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∑–∞–ø—Ä–æ—Å—ã

    # --- –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ: –ö–æ–¥ –ø–æ—Å–ª–µ yield ---
    # –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –û–î–ò–ù –†–ê–ó –ø—Ä–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ —Å–µ—Ä–≤–µ—Ä–∞
    print("Lifespan shutting down")
    if os.getenv("TESTING") != "True" and app.state.pool:
        await close_db_connection(app)


# --- 3. –°–æ–∑–¥–∞–µ–º –∏ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ ---

# –°–æ–∑–¥–∞–µ–º –≥–ª–∞–≤–Ω—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä FastAPI –∏ –ø–µ—Ä–µ–¥–∞–µ–º –µ–º—É –Ω–∞—à lifespan
app = FastAPI(
    title='My Refactored FastAPI App',
    description="–≠—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä—É–µ—Ç –º–æ–¥—É–ª—å–Ω—É—é –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É —Å –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–µ–π, WebSocket –∏ —Ñ–æ–Ω–æ–≤—ã–º–∏ –∑–∞–¥–∞—á–∞–º–∏.",
    version='2.0.0',
    lifespan=lifespan 
)


# --- 4. –ü–æ–¥–∫–ª—é—á–∞–µ–º —Ä–æ—É—Ç–µ—Ä—ã ---
# –ò—Å–ø–æ–ª—å–∑—É–µ–º app.include_router(), —á—Ç–æ–±—ã –ø–æ–¥–∫–ª—é—á–∏—Ç—å –≤—Å–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã –∏–∑ –Ω–∞—à–∏—Ö –º–æ–¥—É–ª–µ–π.
# FastAPI –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±—Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–µ—Ñ–∏–∫—Å—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä, /auth, /compute), –∫–æ—Ç–æ—Ä—ã–µ –º—ã –∑–∞–¥–∞–ª–∏ –≤ –∫–∞–∂–¥–æ–º —Ä–æ—É—Ç–µ—Ä–µ.

# 1. –°–Ω–∞—á–∞–ª–∞ –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Ä–æ—É—Ç–µ—Ä—ã (–≤—Å–µ–≥–¥–∞)
from websocket import router as websocket_router
# –ü–æ–¥–∫–ª—é—á–∞–µ–º —Ç–æ–ª—å–∫–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ —Ä–æ—É—Ç–µ—Ä—ã –¥–ª—è —Ç–µ—Å—Ç–æ–≤
# bg_tasks –ø–æ–∫–∞ –º–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å –ø–æ–¥ —É—Å–ª–æ–≤–∏–µ–º, –µ—Å–ª–∏ –Ω–µ –Ω—É–∂–Ω–æ –∏—Ö —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å
if os.getenv('TESTING') != 'True':
    from bg_tasks import router as tasks_router
    app.include_router(tasks_router)

# 2. –ü–æ–¥–∫–ª—é—á–∞–µ–º –æ—Å–Ω–æ–≤–Ω—ã–µ —Ä–æ—É—Ç–µ—Ä—ã (–í–°–ï–ì–î–ê)
app.include_router(auth_router)
app.include_router(products_router)
app.include_router(websocket_router)


# --- 5. –ö–æ—Ä–Ω–µ–≤–æ–π —ç–Ω–¥–ø–æ–∏–Ω—Ç (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) ---
# –≠—Ç–æ –ø—Ä–æ—Å—Ç–æ–π —ç–Ω–¥–ø–æ–∏–Ω—Ç, —á—Ç–æ–±—ã –º–æ–∂–Ω–æ –±—ã–ª–æ –ª–µ–≥–∫–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω.
@app.get('/', tags=['Root'])
def read_root():
    """–ü—Ä–æ—Å—Ç–æ–π —ç–Ω–¥–ø–æ–∏–Ω—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞ API."""
    return {'status': 'API is running'}